<!-- 
SPDX-FileCopyrightText: the TeamDojo authors

SPDX-License-Identifier: Apache-2.0
-->

# ADR-0005: Move Teamscore calculation to the backend

| <!-- -->       | <!-- -->                                                                                   |
|----------------|--------------------------------------------------------------------------------------------|
| **Status**:    | PROPOSED                                                                                   |
| **Date**:      | 2022-10-25                                                                                 |
| **Author(s)**: | Amar Bolkan <amar.bolkan@iteratec.com>, Sven Strittmatter <sven.strittmatter@iteratec.com> |

## Context

TeamDojo has a feature, which tracks a score for each team. Calculation of this score is currently done client side.
To calculate the score for a specific team the following entities are queried from the backend:

- all available skills: `api/skills`
- teamskills: `/api/team-skills`
- team: `/api/teams`
- all available badges: `api/badges`

In the dashboard view this leads to all Teamskills (possibly #Teams * #Skills) being loaded into the frontend.

#### Problem

Depending on the number of Teamskills the scores can be incorrect. This happens due to `Pagination` and the
client `only querying the first page`.
The solution up to this point has been to simply increase the page size. This however is not a long term solution,
especially in terms of scalability as the
maximum number of Teamskills can increase quit rapidly.

There appear to be two general approaches one of which would be fixing the problem in the frontend and the other to move
the entire calculation into the backend.

### Solution 1: Check if all pages have been queried

Instead of increasing the maximum amount of entities per page, the client could check if all pages have been queried.
This would ensure that all Teamskills have been retrieved from the backend and in turn should lead to all Teamscores
being calculated correctly.

### Pros

- low implementation effort, query for Teamskills only needs to be put into a loop
- no new files need to be added / no custom code needs to be changed or extended

### Cons

- keeps the computational load on the client
- `Teamscores` can't easily be queried by third party software
- might negatively impact scalability of the system, due to increasing amounts of data needing to be queried

### Solution 2: Moving the calculation into the backend

Create a new Service, which queries a backend Api that calculates the score for a team on demand.

#### Pros

- the new API would allow for third party systems to query `Teamscores`, which would for example enable easy monitoring
  through something like Prometheus
- client performance should increase because calculation is now done server side
- calculating the score on demand avoids having to check after every CRUD operation if the previously calculated score
  is still correct.

#### Cons

- changes need to be made in client code
- custom classes need to be added to the backend. Those might need to be maintained, when updating to new Jhipster
  versions

<!-- ## Notes (can be deleted once solution is implemented) ##

Files to be added to the backend:
- `CustomTeamscoreResource`
- `CustomTeamScoreService`

Files to be changed in the frontend:
- `src/main/webapp/app/custom/overview/teams/overview-teams.component.ts`
- `src/main/webapp/app/custom/teams/teams-status/teams-status.component.ts`

Files to be deleted:
- `src/main/webapp/app/custom/helper/team-score-calculation.ts` 

-->


<!-- ## Notes (can be deleted once solution is implemented) ##

Relevant files for score calculation:
- CompletionCheck `src/main/webapp/app/custom/helper/completion-check.ts`
- RelevanceCheck `src/main/webapp/app/custom/helper/relevance-check.ts`
- TeamScoreCalculation `src/main/webapp/app/custom/helper/team-score-calculation.ts`
- SkillStatusUtils `src/main/webapp/app/custom/helper/skill-status.ts`

mirror these classes in the backend
Variable used in TeamScore calculation: team (containing all achieved skills), all available skills, and all available badges
-->

## Decision

We decide to implement Solution 2. The score calculations won't be persisted in the database.

## Consequences

- Moving the `Teamscore` calculation to the backend will shift the computational load to the server
- Making `Teamscores` queryable through a separate API enables third party systems to monitor `Teamscores` over time
- New files need to be added to the backend and client code needs to be adapted

### Persisting Results

Calculating `Teamscores` only on demand means that the same calculation might be done over and over again.
This could in the future lead to a performance bottleneck and might be further discussed in separate ADR. 
